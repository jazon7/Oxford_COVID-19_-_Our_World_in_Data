---
title: "Covid Data and Restrictions - Plotting data"
output: github_document
---
```{r setup, include=FALSE} 
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
```


Load required packages
```{r}
if (!require(pacman)) install.packages('pacman')
library(pacman)
p_load(tidyverse,ggpubr, map_data,ggrepel,ggtext,scales,viridis,ggthemes)
options(scipen=999)
options(warn=-1)
```

Import data frames saved from Extraction.RMD
```{r}
df <- readRDS("OxOw_Extraction_large.rds")
df_small <- readRDS("OxOw_Extraction_small.rds")
```

## Plot Total Restrictions on World MAP
```{r}
date_input <- "2022-05-20"
df_world <- df %>% filter(date == date_input)

world_map <- map_data("world")
world_map <- world_map  %>% select(-c(order,subregion))

#change region to location for consistency
names(world_map)[4] <- "location"

#change USA to United states for consistency
world_map$location <- gsub("USA", "United States", world_map$location)

world <- full_join(world_map,df_world, by = 'location') %>% 
select(location,total_restrictions, group, long, lat)

world_lab_data <- world %>%
  group_by(location) %>%
  summarise(long = mean(long), lat = mean(lat), group = max(group), total_restrictions =   max(total_restrictions))

world_lab_data <- world_lab_data %>% filter(location != "Antarctica")
world <- world %>% filter(location != "Antarctica" )

ggplot(world, aes(x = long, y = lat, group = group)) +
  geom_polygon(aes(fill = total_restrictions), colour = 'white') +
  scale_fill_viridis_c(option = "C", direction = -1) +
  labs(fill = "Total Restrictions") +
  labs(title = "Covid Restriction World Map",
            subtitle = "as of 20th May 2022")+
  geom_text(data = world_lab_data, x = 10, 
            y = 70, label = "Sweden",stat = "unique", size =4, colour = 'darkgreen') +
  geom_text(data = world_lab_data, x = 85, 
            y = 5, label = "India",stat = "unique", size = 4.5, colour = 'red') +
  geom_text_repel(data = world_lab_data, aes(label = location), max.overlaps = 2,
            size=3.5, min.segment.length = 2, colour = 'black') +
  theme_map() +
  theme(    axis.title=element_blank(),
            axis.text=element_blank(),
            axis.ticks=element_blank(),
            plot.title = element_text(hjust = 0.5, size = 16, family="serif"),
            plot.subtitle = element_text(hjust = 0.5, size = 12),
            legend.text=element_text(size=12,family="serif"),
            legend.title=element_text(size=13,family="serif"),
            legend.position="right",
            legend.direction = "vertical")
```


#Scatter plot country comparison
```{r}

#function to filter by continent and date
df_filter_date <- function(dt){
    df <- df_small %>%
      filter(date == dt) %>% 
      filter(!is.na(continent)) %>% 
      select(continent, location, date, total_restrictions, total_deaths_per_million) %>%
      drop_na()
}

#select date
df_date <- df_filter_date(date_input)

#scatter plot 
df_date %>% 
ggplot(aes(x = total_restrictions, y = total_deaths_per_million, label = location)) +
        geom_point(data = df_date, aes(color = continent)) +
        geom_smooth(method = lm, se = F, colour = 'grey') +
        scale_size_continuous(range = c(2,10)) +
        scale_color_viridis(discrete = TRUE, option = 'C') +
        geom_text_repel(max.overlaps = 10, size = 3) +
        annotate("text", label= paste0("R = ", round(with(df_date,
                cor.test(total_restrictions, total_deaths_per_million,method = "pearson"))$estimate, 2),", p = ", 
                round(with(df_date,cor.test(total_restrictions, total_deaths_per_million,method = "pearson"))$p.value, 3),
                ", n = ", nrow(df_date)),x = 1500, y = 6500, color="red", size=3.5) +
        labs(color = "Continent") +
        ylab("Total deaths per million") +
        xlab("Total Restrictions") +
        ggtitle(paste0("Total deaths per million vs Total Restrictions as of ", date_input)) +
        guides(color = guide_legend(override.aes = list(size = 7))) +
        theme_minimal()+
        theme(axis.title = element_text(size = 14, family="serif"),
              axis.text = element_text(size = 12, family="serif"),
              legend.title = element_text(size = 13,family="serif"),
              legend.text = element_text(size = 10,family="serif"),
              plot.title = element_text(size = 14, family="serif"))
```


### Cleanup workspace
```{r}
#cleanup workspace
rm(list=setdiff(ls(), c("df","df_small","world","world_lab_data")))
```
